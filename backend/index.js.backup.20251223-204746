import express from 'express';
import cors from 'cors';

const app = express();
const PORT = process.env.PORT || 8080;

// Middleware
app.use(cors({ origin: '*' }));
app.use(express.json());

// Environment info
const ENVIRONMENT = process.env.ENVIRONMENT || 'production';
const REAL_API = process.env.REAL_API || 'false';
const SYSTEM_ID = process.env.SYSTEM_ID || 'TK_GLOBAL_BANK_PROD';

console.log(`ğŸš€ Starting TK Global Bank`);
console.log(`ğŸ“ Environment: ${ENVIRONMENT}`);
console.log(`ğŸ” Real API: ${REAL_API}`);
console.log(`ğŸ†” System ID: ${SYSTEM_ID}`);

// ============================================
// HEALTH & STATUS
// ============================================
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    version: '30.0.0',
    port: PORT,
    uptime: process.uptime(),
    environment: ENVIRONMENT,
    real_api: REAL_API,
    system_id: SYSTEM_ID,
    timestamp: new Date().toISOString()
  });
});

app.get('/api/zengin/status', (req, res) => {
  res.json({
    online: true,
    coreTime: true,
    totalTransactions: 1,
    supportedBanks: 14,
    serverTime: new Date().toISOString()
  });
});

app.get('/api/real-money/status', (req, res) => {
  res.json({
    enabled: true,
    mode: REAL_API === 'true' ? 'LIVE' : 'SIMULATION',
    status: 'ONLINE'
  });
});

app.get('/api/external/status', (req, res) => {
  res.json({
    wise: 'ONLINE',
    stripe: 'ONLINE',
    revolut: 'ONLINE',
    banking_circle: 'ONLINE'
  });
});

// ============================================
// BALANCE
// ============================================
app.get('/api/balance/:userId', (req, res) => {
  const { userId } = req.params;
  res.json({
    userId,
    balance: 162500000000000,
    currency: 'JPY',
    available: 162500000000000,
    timestamp: new Date().toISOString()
  });
});

app.get('/api/balance/1', (req, res) => {
  res.json({
    userId: '1',
    balance: 162500000000000,
    currency: 'JPY',
    accounts: {
      sbi: 96100000000000,
      rakuten: 85900000000000,
      paypay: 15000000000000
    }
  });
});

// ============================================
// TRANSFERS
// ============================================
app.get('/api/transfers/:userId', (req, res) => {
  res.json({
    userId: req.params.userId,
    transactions: [
      { id: 'tx1', amount: 6800000, from: 'SBI', to: 'Rakuten', status: 'completed' },
      { id: 'tx2', amount: 5000000, from: 'Wise', to: 'USD', status: 'processing' }
    ]
  });
});

app.post('/api/transfer/instant', (req, res) => {
  const { amount, to, note } = req.body;
  res.json({
    success: true,
    type: 'instant',
    amount,
    to,
    note,
    transactionId: `INST-${Date.now()}`,
    status: 'completed',
    timestamp: new Date().toISOString()
  });
});

app.post('/api/transfer/bank', (req, res) => {
  const { amount, to, note } = req.body;
  res.json({
    success: true,
    type: 'bank',
    amount,
    to,
    note,
    transactionId: `BANK-${Date.now()}`,
    status: 'processing',
    estimatedTime: '3-5 business days'
  });
});

app.post('/api/transfer/crypto', (req, res) => {
  const { amount, to, currency } = req.body;
  res.json({
    success: true,
    type: 'crypto',
    amount,
    to,
    currency: currency || 'BTC',
    transactionId: `CRYPTO-${Date.now()}`,
    status: 'pending',
    confirmations: 0
  });
});

app.post('/api/transfer/international', (req, res) => {
  const { amount, from_currency, to_currency, recipient } = req.body;
  res.json({
    success: true,
    type: 'international',
    amount,
    from_currency,
    to_currency,
    recipient,
    transactionId: `INTL-${Date.now()}`,
    status: 'processing',
    estimatedDelivery: '1-2 business days'
  });
});

// ============================================
// LEGAL & COMPLIANCE
// ============================================
app.get('/api/legal/:country', (req, res) => {
  const { country } = req.params;
  const legalInfo = {
    jp: {
      country: 'Japan',
      license: 'è³‡é‡‘ç§»å‹•æ¥­è€…ç™»éŒ²',
      authority: 'é–¢æ±è²¡å‹™å±€',
      compliance: ['KYC', 'AML', 'çŠ¯åæ³•']
    },
    sg: {
      country: 'Singapore',
      license: 'MAS Payment Services',
      authority: 'Monetary Authority of Singapore',
      compliance: ['KYC', 'AML/CFT']
    },
    ae: {
      country: 'UAE',
      license: 'DFSA License',
      authority: 'Dubai Financial Services Authority',
      compliance: ['KYC', 'AML']
    }
  };
  res.json(legalInfo[country.toLowerCase()] || { country, status: 'Not available' });
});

// ============================================
// QR CODE
// ============================================
app.post('/api/qr/generate', (req, res) => {
  const { amount, purpose } = req.body;
  res.json({
    qr: `QR-${Date.now()}`,
    amount,
    purpose,
    expiresIn: '5 minutes',
    qrCodeUrl: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=TKG:${amount}`
  });
});

// ============================================
// ATM
// ============================================
app.post('/api/atm/withdraw', (req, res) => {
  const { amount, location } = req.body;
  res.json({
    success: true,
    amount: amount || 0,
    location: location || 'ATM',
    transactionId: `ATM-${Date.now()}`,
    code: Math.floor(100000 + Math.random() * 900000),
    expiresIn: '5 minutes',
    status: 'approved'
  });
});

// ============================================
// EXCHANGE RATE
// ============================================
app.get('/api/exchange-rate/:from/:to', (req, res) => {
  const { from, to } = req.params;
  const rates = {
    'USD-JPY': 150.25,
    'EUR-JPY': 165.80,
    'GBP-JPY': 190.50
  };
  const key = `${from}-${to}`;
  res.json({
    from,
    to,
    rate: rates[key] || 1.0,
    timestamp: new Date().toISOString()
  });
});

// ============================================
// ROOT
// ============================================
app.get('/', (req, res) => {
  res.json({
    service: 'TK Global Bank API',
    version: '30.0.0',
    environment: ENVIRONMENT,
    status: 'ONLINE',
    endpoints: [
      '/api/health',
      '/api/balance/:userId',
      '/api/transfers/:userId',
      '/api/transfer/instant',
      '/api/transfer/bank',
      '/api/transfer/crypto',
      '/api/transfer/international',
      '/api/legal/:country',
      '/api/qr/generate',
      '/api/atm/withdraw',
      '/api/exchange-rate/:from/:to',
      '/api/zengin/status',
      '/api/real-money/status',
      '/api/external/status'
    ]
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸŒ Environment: ${ENVIRONMENT}`);
  console.log(`âœ… All endpoints active`);
});
